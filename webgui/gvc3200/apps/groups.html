<!-- saved from url=(0022)http://internet.e-mail -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<link href='../css/pageframe.css' type='text/css' rel='stylesheet'>
<link href='../css/apps.css' type='text/css' rel='stylesheet' id="framecssfile">
<script type='text/javascript' src='../js/jquery.tools.min.js'></script>	
<script type="text/javascript" src='../js/jquery.cookie.js'></script>
<script type="text/javascript" src='../js/jquery.stylish-select.min.js'></script>
<script type="text/javascript" src='../js/jquery.prompt.js'></script>
<style>
.contentdiv{text-overflow: ellipsis;white-space:nowrap;overflow:hidden;}
.contentdiv, .editdiv{width:209px;}
.membername{margin-left:8px;}
.membernumber{width:140px;color:#666;}
.searchinput{width:328px !important;}
.desdiv, .memberdiv{padding-left:10px;}
#rightnamediv, .memberdiv{border-bottom:1px solid transparent;width:343px;}
#rightnamediv.hasborder, .hasborder{border-bottom:1px solid #e1e1e1;}
#a_detailmember{color:#1D6EA8;font-weight:bold;}
#search{position: relative;height:30px;line-height:30px;margin-left: 8px;}
.dividline{width:380px;height:1px;font-size:1px;line-height:1px;background:#cecece;float:left;margin-left:-20px;}
.itemname{width:165px;margin-left:13px;}
/**/
#selectcalldiv{width:470px;height:auto;position:absolute;top:40%;margin-top:-150px;left:50%;margin-left:-220px;z-index:1000;background:#F6F7F7;color:#FFF;font-size:16px;box-shadow:0px 0px 10px 2px #919191;}
.selecttitle{width:auto;height:35px;line-height:35px;background:#1D6EA8;padding-left:15px;}
.selecttitle span{float: left;}
#selectlist{color:#222;}
#selectlist .newListSelected{float:left;margin:0 0 0 15px;}
.selectbtn{text-align:center;height:70px;position:relative;*z-index:-1;clear: both;}
.selectbtn button{margin:20px 0 0 15px;}
#selectcalldiv #closecalldiv{width:24px;height:24px;min-width:0px;border:0;background:url("../img/call/close_incomingcall.png") center center transparent no-repeat;border-radius:0px;float:right;margin:5px 5px 0 0;}
#selectcalldiv #closecalldiv.buttonover{background-color:#E32632;}
#selectcall{width:100px;height:30px;background:#4ABE6B;position:relative;}
#selectcall.buttonover{background-color:#32A553;}
#selectcancel{width:100px;height:30px;position:relative;margin-left:48px;}
.dialdiv{*margin-left:10px;}
.multinum{float:left;width:430px;margin:15px 0 0px 40px;}
.choosename{float:left;height:27px;line-height:27px;width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.symbol{float:left;height:27px;line-height:27px;}
#editname{width:209px;}
.itemmembers{margin-left:10px;width:95px;color:#666;text-align:right;}
#divcallbtn{float:right;margin-right:45px;}
</style>
<body id="framebody" class="maintenancebody">
<div id="mainbody" class="maindiv appmaindiv">
    <div id="leftdiv" class="appleft">
        <div webtip="" id="itemsdiv">
            <div id="divcallbtn"><input type="button" id="itemcallbtn" /></div>
        </div>
        <div class="appsbtn">
            <input type="checkbox" id="selectall" class="selectall" />
            <button id="delcontact"></button>
            <button id="addcontact">Add</button>
        </div>  
    </div>
    <div id="rightdiv" class="appright">
        <div id="persondiv" class="detailcontent">
            <div id="righttopdiv">
                <div class="righttopdiv" id="rightnamediv" style="margin-top:10px;">
                    <div class="desdiv"><span id="a_detailname">Group Name</span></div>
                    <div class="contentdiv"><span id="detailname"></span></div>
                    <div class="editdiv"><input id="editname" type="text"></div>
                </div>
                <!--<div class="dividline"></div>-->
                <div class="righttopdiv">
                    <div class="desdiv"><span id="a_detailmember">Group Members</span></div>
                </div>
                <div class="righttopdiv">
                    <div class="desdiv" style="width:300px;padding-left: 0px;"><input id="search" type="text" class="searchinput" /></div>
                </div>
            </div>
            <div webtip="" id="membersdiv">
            
            </div>
        </div>
        <div class="appsbtn" id="rightcheckbtn" style="margin-left:25px;">
            <input type="checkbox" id="selectallmember" class="selectall" style="display:none;" />
        </div>
        <div class="appsbtn" id="rightbtn">
            <button id="savebtn">Save</button>
            <button id="cancelbtn" class="cancelbtn">Cancel</button>
            <button id="editbtn" class="editbtn">Edit</button>
        </div>  
    </div>
    <div id="selectcalldialog" style="width:100%;height:100%;position:absolute;top:0;left:0;display:none;">
        <div id="selectcalldiv">
            <div class="selecttitle"><span>Please select a number to call</span><button id="closecalldiv"></button></div>
            <div id="selectlist">

            </div>
            <div class="selectbtn">
                <button id="selectcall">Call</button><button id="selectcancel" class="cancelbtn">Cancel</button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
	var cookie_lang = $.cookie( "MyLanguage");
    var version = $.cookie("ver");
    if ( !cookie_lang ){
        cookie_lang = 'en';
	}
    if(!version)
        version = new Date().getTime();
    document.write("<script src='../js/public.js?ver=" + version + "'><\/script>");
    document.write("<script src='../lang/" + cookie_lang + ".js?ver=" + version + "'><\/script>");
    //$("#delhis").button();
</script>
<script type="text/javascript" src='../js/apps.js'></script>
<script type="text/javascript">
var mEditMode = 0;
var mSelectId;
var mOptionNum = 0;
var mOptionNumSuc = 0;
var mOptionNumDone = 0;
var mItemsdivObj, mMembersdivObj;
var mUpdateMemberIds;
var mMaxmumber = 8;
var mSearchTimer = 0;

$(function(){
    mItemsdivObj = document.getElementById('itemsdiv');
    mMembersdivObj = document.getElementById('membersdiv'); 
    /***************init state****************/
    $("#delcontact").attr("disabled","disabled").addClass("deldisable");
    $("#rightbtn button").hide();
    /*************************/
    translate_page();
    window.parent.block_download_func(a_6660);
    get_groups();
    
    var height = parseInt($("#iframediv",parent.document.body).css('height'));
    $("#itemsdiv, #persondiv").css("height", height - 60); //30+18
    pageEventActions();
});
function create_nocontact_div(){
    if( $("#nocalldiv").length > 0 ){
        $("#nocalldiv").show();
    }else{
        var nocalldiv = document.createElement('DIV');
        nocalldiv.className='nocalldiv';
        nocalldiv.id='nocalldiv';
        var itemsheight = $("#itemsdiv").css("height");
        nocalldiv.style.lineHeight = itemsheight;
        var nocalltext = document.createElement('SPAN');
        nocalltext.innerHTML = htmlEncode(a_15017);
        nocalldiv.appendChild(nocalltext);
        mItemsdivObj.appendChild(nocalldiv);
    }
    $("#editbtn, .righttopdiv").hide();
    window.parent.unblock_func();
}
function create_group_div(id, disname){
    if( $(".itemdiv[groupid=" + id + "]").length == 0 )
    {
        var itemdiv = document.createElement('DIV');
        itemdiv.className='itemdiv';
        itemdiv.id = "group_" + id;
        itemdiv.setAttribute("name", disname);
        itemdiv.setAttribute("members", "0");
        itemdiv.setAttribute("membersid", "");
        itemdiv.setAttribute("groupid", id);
        
        var checkdiv = document.createElement('DIV');
        checkdiv.className='itemcheck';
        var checkbox = document.createElement('INPUT');
        checkbox.type = 'checkbox';
        checkbox.className = "inputcbx";
        if( $("#selectall").attr("checked") )
            checkbox.checked = true;
        checkdiv.appendChild(checkbox);
        itemdiv.appendChild(checkdiv);
        
        var icondiv = document.createElement('DIV');
        icondiv.className='itemicon';
        var itemicon = document.createElement('DIV');
        itemicon.className='appgroupicon';
        icondiv.appendChild(itemicon);
        itemdiv.appendChild(icondiv);
        
        var namediv = document.createElement('DIV');
        namediv.className='itemname';
        var spantext = document.createElement('SPAN');
        spantext.innerHTML = htmlEncode(disname);
        spantext.setAttribute("title", disname);
        namediv.appendChild(spantext);
        itemdiv.appendChild(namediv);	                                
        
        var numdiv = document.createElement('DIV');
        numdiv.className='itemmembers';
        var numtext = document.createElement('SPAN');
        numtext.innerHTML = "0 " + htmlEncode(a_16646);
        numdiv.appendChild(numtext);
        itemdiv.appendChild(numdiv);
        
        mItemsdivObj.appendChild(itemdiv);
    }
}
function create_contact_div(rawcontactid, disname, number, acctid){
    //use - as a separator,to find the group id quickly when need,show contact for example
    var $rawcontactDiv = $("#rawcontact_" + rawcontactid);
    if( $rawcontactDiv.length != 0 )
    {
        var number_array = $rawcontactDiv.attr("number") + "," + number;
        var acct_array = $rawcontactDiv.attr("account") + "," + acctid;
        var numbernum = parseInt($rawcontactDiv.attr("numbernum")) + 1;
        $rawcontactDiv.attr("number",number_array).attr("account",acct_array).attr("numbernum",numbernum);
        return false;
    }
    var belonggroupname = "-";
    var belonggroupid = "-";
    $(".itemdiv").each(function(){
        var membersid = "," + $(this).attr("membersid") + ",";
        if( membersid.indexOf(","+rawcontactid+",") != -1 ) {
            belonggroupname += $(this).attr("name");
            belonggroupid += $(this).attr("groupid");
            belonggroupname += "-";
            belonggroupid += "-";
            //do not return false here,as one contact can in multiple groups
        }
    });
    
    var memberdiv = document.createElement('DIV');
    memberdiv.className='memberdiv';
    memberdiv.id = "rawcontact_" + rawcontactid;
    memberdiv.setAttribute("name", disname);
    memberdiv.setAttribute("number", number);
    memberdiv.setAttribute("numbernum", 1);
    memberdiv.setAttribute("account", acctid);
    memberdiv.setAttribute("rawcontactid", rawcontactid);
    memberdiv.setAttribute("groupname", belonggroupname);
    memberdiv.setAttribute("groupid", belonggroupid);
    
    var checkdiv = document.createElement('DIV');
    checkdiv.className='membercheck';
    var checkbox = document.createElement('INPUT');
    checkbox.type = 'checkbox';
    checkbox.className = "inputcbx";
    checkbox.setAttribute("groupid", belonggroupid);
    checkdiv.appendChild(checkbox);
    memberdiv.appendChild(checkdiv);

    var iconmemberdiv = document.createElement('DIV');
    iconmemberdiv.className='membericon';
    var itemicon = document.createElement('DIV');
    itemicon.className='appcontacticon';
    iconmemberdiv.appendChild(itemicon);
    memberdiv.appendChild(iconmemberdiv);
    
    var namediv = document.createElement('DIV');
    namediv.className='membername';
    var spantext = document.createElement('SPAN');
    spantext.innerHTML = htmlEncode(disname);
    spantext.setAttribute("title", disname);
    namediv.appendChild(spantext);
    memberdiv.appendChild(namediv);
    
    var numberdiv = document.createElement('DIV');
    numberdiv.className='membernumber';
    var numbertext = document.createElement('SPAN');
    numbertext.innerHTML = htmlEncode(number);
    numbertext.setAttribute("title", number);
    numberdiv.appendChild(numbertext);
    memberdiv.appendChild(numberdiv);
    
    mMembersdivObj.appendChild(memberdiv);
}

function update_contact_div(dataid, rawid, info, acctid, infotype){
    if( info == "" ) return;
    $updatecontact = $("#rawcontact_" + rawid);
    if( infotype == 1 ){
        //email
        var emailattr = $updatecontact.attr("email");
        var emailnum = $updatecontact.attr("emailnum");
        if(emailattr == undefined)
        {
            emailattr = "";
        }
        if(emailnum == undefined)
        {
            emailnum = 0;
        }
        else
        {
            emailnum = parseInt(emailnum);
        }
        if( emailattr != "" ){
            emailattr += ":::";
            emailattr += info;
        }else{
            emailattr = info;
        }
        emailnum ++;
        $updatecontact.attr("email", emailattr).attr("emailnum", emailnum);
    }
    else if( infotype == 5 ){
        //number
        var curnumber = $updatecontact.attr("number");
        var curacct = $updatecontact.attr("account");
        var curnumbernum = $updatecontact.attr("numbernum");
        if(curnumber == undefined)
        {
            curnumber = "";
        }
        if(curacct == undefined)
        {
            curacct = "";
        }
        if(curnumbernum == undefined)
        {
            curnumbernum = 0;
        }
        else
        {
            curnumbernum = parseInt(curnumbernum);
        }
        if( curnumber != "" ){
            curnumber += ":::";
            curacct += ","; 
        }
        curnumber += info;
        curacct += acctid;
        curnumbernum ++;
        $updatecontact.attr("number", curnumber).attr("numbernum", curnumbernum).attr("account", curacct);
    }
}

function parse_contactinfo(items){
    var id, rawid, info, acctid, infotype;
    for (var i = 0; items[i] != undefined; i++)
    {
        id = items[i].Id;
        rawid = items[i].RawId;
        info = items[i].Info;
        acctid = items[i].AcctIndex;
        infotype = items[i].InfoType;
        
        update_contact_div(id, rawid, info, acctid, infotype);
    } 
}

function cb_get_action_done(data, action) {
    if( data.substring(0, 1) == "{" )
    {
        data = data.replace(/\r/g, "\\r").replace(/\n/g, "\\n");
        if( action.indexOf("sqlitecontacts" ) != "-1" ){
            var tObj = eval("(" + data + ")");
            var items = tObj.Data;
            
            if( action.indexOf("type=groups") != "-1" ){   
                var id, disname, rawcontactid;
                for (var i = 0; items[i] != undefined; i++)
                {
                    id = items[i].Id;
                    disname = items[i].Name;
                    rawcontactid = items[i].ContactId;
                                        
                    create_group_div(id, disname);
	                
	                if( rawcontactid > 0 ){
	                    var membernum = $(".itemdiv[name=\"" + disname + "\"]").attr("members");
	                    var membersid = $(".itemdiv[name=\"" + disname + "\"]").attr("membersid");
	                    if( membersid != "" )
	                        membersid += ",";
	                    membersid += rawcontactid;
	                    membernum ++;
	                    var str = " " + a_16646;
	                    if( membernum > 1 ){
	                        str = " " + a_16647;
	                    }
	                    $(".itemdiv[name=\"" + disname + "\"]").attr("members", membernum).attr("membersid", membersid).children(".itemmembers").text(membernum + str); 
	                } 
                }
                get_contact();
            }
            else if( action.indexOf("type=contacts") != "-1" ){  
                var rawcontactid, disname, number, acctid;
                for (var i = 0; items[i] != undefined; i++)
                {
                    rawcontactid = items[i].RawId;
                    disname = items[i].Name;
                    number = items[i].Number;
                    acctid = items[i].AcctIndex;
                    
                    //if( $("#rawcontact_" + rawcontactid).length != 0 ) continue;
                    create_contact_div(rawcontactid, disname, number, acctid);
                }
                
                add_item_event();
                if( $(".itemdiv").length > 0 ){
                    $(".itemdiv").eq(0).click();
                }else{
                    create_nocontact_div();
                }
                window.parent.unblock_func();    
            }
            else if( action.indexOf("type=contactinfo") != "-1" ){
                parse_contactinfo(items);    
                window.parent.unblock_func();           
            }
        }else if(action.indexOf("getcontactsbyorder") != -1 ){
            var tObj = eval("(" + data + ")");
            var items = tObj.Data;
            if( items != undefined ){
                var rawcontactid, disname, number, acctid;
                for (var i = 0; items[i] != undefined; i++)
                {
                    rawcontactid = items[i].RawId;
                    disname = items[i].Name;
                    
                    if( $("#rawcontact_" + rawcontactid).length != 0 ) continue;
                    create_contact_div(rawcontactid, disname, "", "");
                }
            }    
            add_item_event();
            if( $(".itemdiv").length > 0 ){
                $(".itemdiv").eq(0).click();
            }
            get_contact_info();
        }else if(action.indexOf("removegroup") != -1 ){
            var tObj = eval("(" + data + ")");
            if( tObj.res == "success" ){
                mOptionNumSuc ++;
                $("#divcallbtn").appendTo($("#itemsdiv"));
                var deleteid = (action.split("="))[2];
                if( deleteid == "" ){
                    $("#itemsdiv .itemdiv").remove();
                    $("#selectall").removeAttr("checked");
                    create_nocontact_div();
                }else{
                    $("#group_" + deleteid).remove();
                }
            }
            mOptionNumDone ++;
            if( mOptionNum == mOptionNumDone ){
                window.parent.unblock_func();
                if( mOptionNumSuc == 0 ){
                    $.prompt(a_58);
                }else if( mOptionNum == mOptionNumSuc ){
                    //$.prompt(a_del_ok);
                    if( $(".itemdiv").length == 0 ){
                        $("#detailname").text("");
                        $("#selectall").attr("checked", false);
                        $("#editbtn, .memberdiv").hide();
                    }else{
                        $(".itemdiv").eq(0).click();
                    }
                    $("#delcontact").attr("disabled","disabled").addClass("deldisable");
                }else{
                    $.prompt(a_16428);
                }
            }
        }else if(action.indexOf("setgroup") != -1 ){
            var tObj = eval("(" + data + ")");
            if( tObj.res == "success" ){
                $("#nocalldiv").hide();
                var newid = parseInt(tObj.msg);
                var disname = $("#editname").val();
                if( mEditMode == 1 ){
                    //add
                    create_group_div(newid, disname);
                    add_item_event();
                    if( mUpdateMemberIds != "" )
                        update_group_members(newid);
                    else
                    {
                        $("#group_" + newid).click();
                        window.parent.unblock_func();
                    }
                }else{
                    //edit
                    $("#group_" + mSelectId).attr("name", disname);
                    $("#group_" + mSelectId).children(".itemname").children("span").text(disname).attr("title", disname);
                    update_group_members(mSelectId);
                }
            }else{
                if( tObj.msg == "-1" )
                    $.prompt(a_4834);
                else{
                    if( mEditMode == 1 ){
                        $.prompt(a_7363);
                    }else{
                        $.prompt(a_3317);
                    }
                }
                window.parent.unblock_func();
            }
        }else if(action.indexOf("updateGroupMemberShip") != -1 ){
            var tObj = eval("(" + data + ")");
            if( tObj.res == "success" ){
                var newid = parseInt(tObj.msg);
                clear_specified_groupid_attr(newid);
                var groupid, membersid = "";
                var membernum = 0;
                $(".membercheck .inputcbx").each(function(){
                    groupid = $(this).attr("groupid");
                    if( $(this).prop("checked") ){
                        if( groupid.indexOf("-"+newid+"-") == -1 ){
                            if( groupid == "" ){
                                groupid += "-";
                            }else{
                                groupid += newid;
                                groupid += "-";
                            }
                            if( membersid != "" ){
                                membersid += ",";
                            }
                            membersid += $(this).parent(".membercheck").parent(".memberdiv").attr("rawcontactid");
                            membernum ++;
                            $(this).attr("groupid", groupid);
                            $(this).parent(".membercheck").parent(".memberdiv").attr("groupid", groupid);
                        }                       
                    }/*else{
                        if( groupid.indexOf("-"+newid+"-") != -1 ){
                            groupid = groupid.replace("-"+newid+"-", "-");
                            $(this).attr("groupid", groupid);
                            $(this).parent(".membercheck").parent(".memberdiv").attr("groupid", groupid);
                        }
                    }*/
                });
                $("#group_" + newid).children(".itemmembers").text(membernum + " " + (membernum > 1 ? a_16647 : a_16646));
                $("#group_" + newid).attr("members", membernum).attr("membersid", membersid).click();
            }else{
                $.prompt(a_7363);
            }
            window.parent.unblock_func();
        }else if(action.indexOf("cleargroup") != -1 ){
            var tObj = eval("(" + data + ")");
            if( tObj.res == "success" ){
                clear_specified_groupid_attr(mSelectId);
                $("#group_" + mSelectId).children(".itemmembers").text( "0 " + a_16646);
                $("#group_" + mSelectId).attr("members", "0").attr("membersid", "").click();
            }else{
                if( mUpdateMemberIds == "" ){
                    $("#group_" + mSelectId).click();
                }else{
                    $.prompt(a_16005);
                }
            }
            window.parent.unblock_func();
        }
    }else{
        if(action.indexOf("getcontactsbyorder") != -1){
            window.parent.unblock_func();
        }
        var msgs = res_parse_rawtext(data);
        cb_if_auth_fail(msgs);
    }
}
function clear_specified_groupid_attr(groupid){
    //clear the specified old groupid first
    var membersidattr = $("#group_" + groupid).attr("membersid");
    if( membersidattr != "" ){
        var membersids = membersidattr.split(",");
        var oldgroupid;
        for(var i = 0; i < membersids.length; i++){
            if( $("#rawcontact_" + membersids[i]).length == 0 ) continue;
            oldgroupid = $("#rawcontact_" + membersids[i]).attr("groupid");
            oldgroupid = oldgroupid.replace("-"+groupid+"-", "-");
            $("#rawcontact_" + membersids[i]).attr("groupid", oldgroupid).children(".membercheck").children(".inputcbx").attr("groupid", oldgroupid);
        }
    }
}
function add_item_event(){
    $(".itemdiv").unbind(); //to avoid too many click callback by one click
    $(".itemdiv").hover(function(){
        $(this).children(".itemmembers").hide();
        $(this).addClass("hoverItem");
        $("#divcallbtn").appendTo($(this)).show();
    },function(){
        //if( mSelectId != $(this).attr("groupid") )
            $(this).removeClass("hoverItem");
        $("#divcallbtn").hide();
        $(this).children(".itemmembers").show();
    });

    $(".itemdiv").click(function(){
        if( mEditMode != 0 ) {
            $("#cancelbtn").click();
        }
        var disname = $(this).attr("name");
        mSelectId = $(this).attr("groupid");
        $("#search").val("");
        $("#detailname").text(disname).attr("title",disname);
        $(".memberdiv, .membercheck").hide();
        $(".memberdiv, #rightnamediv").addClass("hasborder");
        var selstr = "-" + mSelectId + "-";
        $(".memberdiv").each(function(){
            if( $(this).attr("groupid").indexOf(selstr) != -1 ){
                $(this).show();
            }else{
                $(this).hide();
            }
        });
        $(this).addClass("selectItem").siblings(".itemdiv").removeClass("selectItem");
        
        $("#rightbtn button, #selectallmember").hide();
        $("#selectallmember").removeAttr("checked");
        $("#editbtn").show();
    }); 
}

function translate_page(){
    $("#a_pagetitle").text(a_310);
    $("#a_cancel").text(a_3);
    $("#delcontact").text(a_19067);
    $("#addcontact").text(a_23);
    $("#editbtn").text(a_22);
    $("#savebtn").text(a_17);
    $("#cancelbtn").text(a_3);
    $("#a_detailname").text(a_7474);
    $("#a_detailmember").text(a_16046);
    $("#selectcalldiv .selecttitle span").text(a_16656);
    $("#selectcancel").text(a_3);
    $("#selectcall").text(a_504);
}

function update_group_members(id){
    if( mUpdateMemberIds != "" ){
        var action = "updateGroupMemberShip&region=webservice&id=";
        action += id;
        action += "&contactids=";
        action += encodeURIComponent(mUpdateMemberIds);
        mOptionNum ++;
        cb_get_action(action);
    }else{
        if( mEditMode == 2 )
            cb_get_action("cleargroup&region=webservice&groupID=" + id);
    } 
}
function on_search_key(){
    var searchkey = $("#search").val().toLowerCase();
    var selstr = "-" + mSelectId + "-";
        
    $(".memberdiv").each(function(){
        if( ($(this).attr("number").toLowerCase()).indexOf(searchkey) == -1 && ($(this).attr("name").toLowerCase()).indexOf(searchkey) == -1 )
        {
            $(this).hide();
        }else{
            if( mEditMode == 0 && $(this).attr("groupid").indexOf(selstr) == -1 ){
                $(this).hide();
            }else
                $(this).show();
        }
    });
    var isall = 1;
    if( $(".membercheck .inputcbx:visible").length == 0 )
        isall = 0;
    else{
        $(".membercheck .inputcbx:visible").each(function(index, item) {
            if ($(item).prop("checked") != true) {
                isall = 0;
                return false;   
            }
        });
    }
    if( isall == 0 )
        $("#selectallmember").removeAttr("checked");
    else
        $("#selectallmember").attr("checked", "checked");
}
function pageEventActions(){
    /***************serach hover function********************/
    $("#dialnow,#search").hover(function(){
            $(this).css("borderColor","#4ABE6B").siblings().css("borderColor","#4ABE6B");
        },function(){
            $(this).css("borderColor","#d9d9d9").siblings().css("borderColor","#d9d9d9");
    });
    /***************hover function end********************/

    $("#itemcallbtn").mouseover(function(){
        $(this).addClass('buttonover');
    }).mouseout(function(){
        $(this).removeClass('buttonover');
    }); 

    $("#editbtn").click(function(){
        $("#search").val("");
        mEditMode = 2;
        $("#editname").val( $("#detailname").attr("title") );
        $(".contentdiv").hide();
        $(".memberdiv, #rightnamediv").removeClass("hasborder");
        $(".editdiv").show();
        var selstr = "-" + mSelectId + "-";
        $(".memberdiv .inputcbx").each(function(){
            if( $(this).attr("groupid").indexOf(selstr) != -1 ){
                $(this).attr("checked", true);
            }else{
                $(this).attr("checked", false);
            }
        });
        $(".membercheck, .memberdiv").show();
        $("#savebtn,#cancelbtn, #selectallmember").show();
        $("#editbtn").hide();
        $("#editname").focus();
    });

    $("#addcontact").click(function(){
        $("#search").val("");
        mEditMode = 1;
        $(".membercheck .inputcbx").each(function(){
            $(this).attr("checked", false);
        });
        $(".memberdiv, #rightnamediv").removeClass("hasborder");
        $("#selectallmember").attr("checked", false);
        $("#editname").val("");
        $(".contentdiv").hide();
        $(".righttopdiv, .editdiv").show();
        $(".membercheck, .memberdiv").show();
        $("#savebtn,#cancelbtn, #selectallmember").show();
        $("#group_"+mSelectId).removeClass("selectItem");
        $("#editbtn").hide();
        $("#editname").focus();
    });
    
    $("#delcontact").click(function(){
        if( $(".itemdiv").length == 0 ) return false;
        var txt = '<div class="shortmsg">' + a_9334 + '</div>';
        $.prompt(txt,{
            buttons:{
                Yes: true, No: false
            },
            callback: function(v,m,f){
                if(v) {  
                    window.parent.block_download_func(a_59);
                    mOptionNum = 0;
                    mOptionNumSuc = 0;
                    mOptionNumDone = 0;
                    if( $("#selectall").prop("checked") == true ){
                        mOptionNum = 1;
                        if( mEditMode != 0 )
                            $("#group_" + mSelectId).click();
                        cb_get_action("removegroup&region=webservice&groupID="); 
                    }else{
                        $(".itemcheck .inputcbx").each(function(index, item) {
                            if ($(item).prop("checked") == true) {
                                mOptionNum ++;
                                cb_get_action("removegroup&region=webservice&groupID=" + $(this).parent(".itemcheck").parent(".itemdiv").attr("groupid"));   
                            }
                        });
                    }
                }
                else {}
            }
        });  
    });
    
    $(".itemcheck .inputcbx").live("click", function() {
        if ($(this).prop("checked") != true) {
            var isall = 1;
            $("#selectall").removeAttr("checked");//.button("refresh");
            $(".itemcheck .inputcbx").each(function(index, item) {
                if ($(item).prop("checked") == true) {
                    isall = 0;
                    return false;   
                }
            });

            if(isall == 0)
                $("#delcontact").removeAttr("disabled").removeClass("deldisable");
            else
                $("#delcontact").attr("disabled","disabled").addClass("deldisable");

        } else {
            var isall = 1;
            $(".itemcheck .inputcbx").each(function(index, item) {
                if ($(item).prop("checked") != true) {
                    isall = 0;
                    return false;   
                }
            });

            if (isall == 1)
                $("#selectall").attr("checked", "checked");//.button("refresh");

            $("#delcontact").removeAttr("disabled").removeClass("deldisable");
        }
    });

    $("#selectall").click(function(){
        if ($(this).prop("checked") == true) {
            $(".itemcheck .inputcbx").attr("checked", "checked");//.button("refresh");
            if( $(".itemdiv").length > 0 )
                $("#delcontact").removeAttr("disabled").removeClass("deldisable");
        } else {
            $(".itemcheck .inputcbx").removeAttr("checked");//.button("refresh");
            $("#delcontact").attr("disabled","disabled").addClass("deldisable");
        }
    });

    $(".membercheck .inputcbx").live("click", function() {
        var isall = 0;
        if ($(this).prop("checked") == true) {
            isall = 1;
            $(".membercheck .inputcbx:visible").each(function(index, item) {
                if ($(item).prop("checked") != true) {
                    isall = 0;
                    return false;   
                }
            });
        }
        if (isall == 1)
            $("#selectallmember").attr("checked", "checked");//.button("refresh");
        else
            $("#selectallmember").removeAttr("checked");//.button("refresh");
    });
    
    $("#selectallmember").click(function(){
        if ($(this).prop("checked") == true) {
            $(".membercheck .inputcbx:visible").attr("checked", "checked");//.button("refresh");
        } else {
            $(".membercheck .inputcbx:visible").removeAttr("checked");//.button("refresh");
        }
    });
    
    $("#search").bind('input propertychange', function() {
        if(mSearchTimer > 0) 
            clearTimeout(mSearchTimer);
        mSearchTimer = setTimeout("on_search_key();", 350);
    });

    $("#cancelbtn").click(function(){
        $("#search").val("");
        $(".contentdiv").show();
        $(".editdiv").hide();
        if( mEditMode == 1 ){
            var selstr = "-" + mSelectId + "-";
            $(".memberdiv").each(function(){
                if( $(this).attr("groupid").indexOf(selstr) != -1 ){
                    $(this).show();
                }else{
                    $(this).hide();
                }
            });
            $("#group_"+mSelectId).addClass("selectItem");
        }else{
            $(".memberdiv").each(function(){
                if( $(this).children(".membercheck").children(".inputcbx").prop("checked") == false ){
                    $(this).hide();
                }else{
                    $(this).show();
                }
            });
        }
        mEditMode = 0;
        $(".memberdiv, #rightnamediv").addClass("hasborder");
        $(".membercheck, #savebtn,#cancelbtn, #selectallmember").hide();
        $("#selectallmember").removeAttr("checked");
        if( $(".itemdiv").length == 0 ){
            $(".righttopdiv, .contentdiv, #editbtn, .memberdiv").hide();
        }else
            $("#editbtn").show();
    });

    $("#itemcallbtn").click(function(e){
        var confstate = $("#disconfstate",window.parent.document).val();
        var flag = true;
        if(confstate == "1")
        {
            $.prompt(a_560);
            return false;
        }
        if(confstate == "0")
        {
            if($("#pause",window.parent.confFrame.document).attr("ishold") == "0")
            {
                $.prompt(a_10080);
                return false;
            }
            var busylinenum = parseInt($("#busylinenum",window.parent.document).val());
            if(busylinenum >= 8){
                $.prompt(a_16683);
                flag = false;
            }
            /*var urihead = "action=isanylinebusy&region=webservice";
            urihead += "&time=" + new Date().getTime();
            $.ajax ({
                type: 'get',
                url:'/manager',
                data:urihead,
                async:false,
                dataType:'text',
                success:function(data) {
                    if( data.substring(0, 1) == "{" )
                    {
                        var tObj = eval("(" + data + ")");
                        if(tObj.msg == "true")
                        {
                            $.prompt(a_16683);
                            flag = false;
                        }
                    }
                },
                error:function(xmlHttpRequest, errorThrown) {
                    cb_networkerror(xmlHttpRequest, errorThrown);
                }
            });*/
        }
        if(!flag)
            return false;

        var $callitem = $(this).parent().parent();
        var membernum = $callitem.attr("members");
        var membersid = $callitem.attr("membersid");
        var groupid = $callitem.attr("groupid");
        var confnumbers = "", confaccts = "", fornum = 0;
        membersid = membersid.split(",");
         
        if(membernum > 8)
            fornum = mMaxmumber;
        else
            if(membernum == 0)
            {
                $.prompt(a_16665);
                return false;
            }
            else
                fornum = membersid.length;

        var selstr = "-" + $callitem.attr("groupid") + "-";
        var temp = 0;
        var flag_showmultinum = false;
        $(".memberdiv").each(function(){
            var $this = $(this);
            if( $this.attr("groupid").indexOf(selstr) != -1 ){
                if(temp < fornum)
                {
                    var number = $this.attr("number");
                    var numbernum = parseInt($this.attr("numbernum"));
                    var account = $this.attr("account");
                    if (numbernum > 1) 
                    {
                        var dialnumarray = number.split(",");
                        var dialacctarray = account.split(",");
                        var contactname = $this.attr("name");
                        var namediv = "<div class='choosename'>"+htmlEncode(contactname)+"</div>";
                        var dialsel = "<select class='dialnumselect' dialacct="+account+">";
                        for(var i = 0;i < numbernum; i++)
                        {
                            var numopt = "<option value='"+dialnumarray[i]+ "' dialacct=" + dialacctarray[i] + ">"+htmlEncode(dialnumarray[i])+"</option>";
                            dialsel += numopt;
                        }
                        dialsel += "</select>";
                        var multinumdiv = "<div class='multinum'>"+ namediv + "<div class='symbol'>:</div>" + dialsel +"</div>";
                        $("#selectlist").append(multinumdiv);
                        $(dialsel).find("option:eq(0)").attr("selected","selected");
                        flag_showmultinum = true;
                    }
                    else
                    {
                        var contactsid = membersid[temp];
                        if( contactsid != undefined){
                            if( confnumbers != "" ){
                                confnumbers += ":::";
                                confaccts += ":::";
                            }
                            confnumbers += number;
                            confaccts += account;
                        }
                    }
                }
                else{
                    return false;
                }
                temp++;
            }
        });
        /*
        for(var i=0 ; i<fornum ; i++)
        {
            var contactsid = membersid[i];
            var $callcontacts = $("#membersdiv .memberdiv[rawcontactid=\""+contactsid+"\"]");
            var number = $callcontacts.attr("number");
            var numbernum = $callcontacts.attr("numbernum");
            var account = $callcontacts.attr("account");
            if(numbernum > 1)
            {
                //if the contact has more than one number, call the first
                number = number.split(":::");
                number = number[0];
                account = account.split(",");
                account = account[0];
            }
            if( contactsid != undefined){
                if( confnumbers != "" ){
                    confnumbers += ":::";
                    confaccts += ":::";
                }
                confnumbers += number;
                confaccts += account;
            }
        }*/    
        if(flag_showmultinum)
        {
            var onenumber = "<div id='existconfmember' confnumber=\""+confnumbers+"\" confaccts=\""+confaccts+"\"></div>"
            $("#selectlist").append(onenumber);
            $("#existconfmember").hide();
            $("#selectcalldialog").show();
            $(".dialnumselect").sSelect({ddMaxHeight:'250px'});
            return false;
        }
        if( confnumbers == "" ){
            $.prompt(a_16665);
            return false;
        }   
        //cb_get_action("addconfmemeber&region=confctrl&numbers=" + encodeURIComponent(confnumbers) + "&accounts=" + encodeURIComponent(confaccts) + "&confname=");
        cb_start_addmemberconf(confnumbers, confaccts, "","");
        e.stopPropagation();
    });

    $("#selectcall").click(function(){
        var confnumbers = $("#existconfmember").attr("confnumber");
        var confaccts = $("#existconfmember").attr("confaccts");
        
        $(".dialnumselect").each(function(){
            var numberselect = $(this).val();
            var acctselect = $(this).find("option:selected").attr("dialacct");

            if( confnumbers != "" ){
                confnumbers += ":::";
                confaccts += ":::";
            }
            confnumbers += numberselect;
            confaccts += acctselect;
        });
        if( confnumbers == "" ){
            $.prompt(a_16665);
            return false;
        }
        
        //cb_get_action("addconfmemeber&region=confctrl&numbers=" + encodeURIComponent(confnumbers) + "&accounts=" + encodeURIComponent(confaccts) + "&confname=");
        cb_start_addmemberconf(confnumbers, confaccts, "","");
        $("#selectcalldialog").hide();
        $("#selectlist").empty();
    });

    $("#closecalldiv,#selectcancel").click(function(){
        $("#selectcalldialog").hide();
        $("#selectlist").empty();
    });

    $("#savebtn").click(function(){
        var newgpname = $.trim($("#editname").val());
        if( newgpname == "" ){
            $.prompt(a_7435);
            return false;
        }
        if( mEditMode == 1 && $(".itemdiv[name=\""+newgpname+"\"]").length > 0 ){
            $.prompt(a_4834);
            return false;
        }
        window.parent.block_download_func(a_6660);
        mUpdateMemberIds = "";
        var rawcontactid = "", checkids = ":::";
        $(".membercheck .inputcbx").each(function(){
            if( $(this).prop("checked") ){
                rawcontactid = $(this).parent(".membercheck").parent(".memberdiv").attr("rawcontactid");
                if( checkids.indexOf(":::"+rawcontactid+":::") != -1 ){
                    //already exist in mUpdateMemberIds
                }else{
                    if( mUpdateMemberIds != "" ){
                        mUpdateMemberIds += ":::";
                    }
                    mUpdateMemberIds += rawcontactid;
                    checkids += rawcontactid;
                    checkids += ":::";
                }
            }
        });
        if (mEditMode == 2 && newgpname == $("#detailname").attr("title") ) {
            update_group_members(mSelectId);
        }else{
            var infostr = "";
            if( mEditMode == 2 )
                infostr += mSelectId;
            infostr += ":::";
            infostr += newgpname;
        
            cb_get_action("setgroup&region=webservice&groupInfo=" + encodeURIComponent(infostr) + "&format=json");
        }
    });
}
 
</script>

</body>

</html>
